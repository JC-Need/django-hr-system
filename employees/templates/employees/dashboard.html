{% load humanize %}
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Sarabun', sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .icon-box { font-size: 2.5rem; opacity: 0.8; }
        .chart-container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-secondary"><i class="fas fa-chart-line"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (HR Dashboard)</h2>
        <form action="{% url 'logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </form>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                        <h2 class="display-6 fw-bold">{{ total_employees }}</h2>
                        <p class="card-text small">‡∏Ñ‡∏ô</p>
                    </div>
                    <div class="icon-box"><i class="fas fa-users"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°</h6>
                        <h2 class="display-6 fw-bold">{{ total_salary|intcomma }}</h2>
                        <p class="card-text small">‡∏ö‡∏≤‡∏ó</p>
                    </div>
                    <div class="icon-box"><i class="fas fa-money-bill-wave"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏≤ (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</h6>
                        <h2 class="display-6 fw-bold">{{ pending_leaves }}</h2>
                        <p class="card-text small">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                    <div class="icon-box"><i class="fas fa-clock"></i></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger h-100">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title">‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                        <h2 class="display-6 fw-bold">{{ absent_today }}</h2>
                        <p class="card-text small">‡∏Ñ‡∏ô</p>
                    </div>
                    <div class="icon-box"><i class="fas fa-user-times"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <div class="chart-container h-100">
                <h5 class="text-muted mb-3">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h5>
                <canvas id="barChart"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container h-100">
                <h5 class="text-muted mb-3">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h5>
                <canvas id="pieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="m-0 fw-bold"><i class="fas fa-umbrella-beach"></i> ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for leave in on_leave_list %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ leave.employee.first_name }} {{ leave.employee.last_name }}</strong>
                                <br><small class="text-muted">{{ leave.employee.department }}</small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ leave.leave_type }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="m-0 fw-bold"><i class="fas fa-user-slash"></i> ‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô / ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                    <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in absent_list %}
                                <tr>
                                    <td>{{ emp.first_name }} {{ emp.last_name }}</td>
                                    <td><span class="badge bg-light text-dark border">{{ emp.department }}</span></td>
                                    <td><a href="tel:{{ emp.phone }}" class="text-decoration-none">{{ emp.phone }}</a></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-success py-4">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                                        ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß!
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 font-weight-bold text-primary">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                    <th class="text-center">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                    <th class="text-end">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏£‡∏ß‡∏°</th>
                                    <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dept in dept_summary %}
                                <tr>
                                    <td class="fw-bold">
                                        {% if dept.department %}
                                            <a href="{% url 'department_detail' dept.department %}" class="text-decoration-none text-primary">
                                                {{ dept.department }} <i class="fas fa-external-link-alt small"></i>
                                            </a>
                                        {% else %}
                                            <span class="text-muted">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ú‡∏ô‡∏Å</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info text-dark rounded-pill">{{ dept.count }}</span>
                                    </td>
                                    <td class="text-end fw-bold">
                                        {% if dept.department %}
                                            <a href="{% url 'department_detail' dept.department %}" class="text-decoration-none text-success">
                                                {{ dept.total_salary|floatformat:2|intcomma }}
                                            </a>
                                        {% else %}
                                            <span class="text-success">{{ dept.total_salary|floatformat:2|intcomma }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 5px; width: 60px; margin: auto;">
                                            <div class="progress-bar bg-primary" style="width: 75%"></div>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 font-weight-bold text-dark">üîî ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</h5>
                    <span class="badge bg-danger">‡∏™‡∏î!</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for act in activities %}
                        <div class="list-group-item d-flex align-items-center p-3 border-bottom-0">
                            <div class="me-3 d-flex align-items-center justify-content-center rounded-circle {{ act.bg }}" style="width: 45px; height: 45px;">
                                <i class="fas {{ act.icon }} {{ act.color }} fa-lg"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 fw-bold text-dark" style="font-size: 0.95rem;">{{ act.text }}</h6>
                                <small class="text-muted"><i class="far fa-clock"></i> {{ act.time|time:"H:i" }} ‡∏ô.</small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-bed fa-3x mb-3 opacity-25"></i>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-light text-center small text-muted">
                    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á (Bar Chart) ---
    const ctxBar = document.getElementById('barChart').getContext('2d');
    new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: {{ bar_labels|safe }},
            datasets: [{
                label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏°‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
                data: {{ bar_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏á‡∏Å‡∏•‡∏° (Pie Chart) ---
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['‡∏°‡∏≤‡∏ó‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', '‡∏Ç‡∏≤‡∏î‡∏á‡∏≤‡∏ô'],
            datasets: [{
                data: {{ pie_data|safe }},
                backgroundColor: [
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(255, 99, 132, 0.7)'
                ],
            }]
        },
        options: { responsive: true }
    });
</script>

</body>
</html>